/*
-- ==========================================================
--  SISTEMA DE NOTICIAS DIGITALES
--  Modelo relacional + Procedimientos almacenados + Ejemplos
-- ==========================================================

-- Limpieza previa (opcional)
BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE ENVIO_AUTOMATICO CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE PREFERENCIA_ENVIO CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE COMENTARIO CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE CALIFICACION CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE NOTICIA CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE SUBTEMA CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE TEMA CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE USUARIO CASCADE CONSTRAINTS';
    EXECUTE IMMEDIATE 'DROP TABLE PARAMETRO_SISTEMA CASCADE CONSTRAINTS';
EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/
-- ----------------------------------------------------------

-- TABLAS
-- ----------------------------------------------------------

CREATE TABLE USUARIO (
    ID_USUARIO NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NOMBRE VARCHAR2(100) NOT NULL,
    EMAIL VARCHAR2(150) UNIQUE NOT NULL,
    PASSWORD VARCHAR2(100) NOT NULL,
    FECHA_REGISTRO DATE DEFAULT SYSDATE
);

CREATE TABLE TEMA (
    ID_TEMA NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NOMBRE VARCHAR2(100) UNIQUE NOT NULL
);

CREATE TABLE SUBTEMA (
    ID_SUBTEMA NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ID_TEMA NUMBER NOT NULL,
    NOMBRE VARCHAR2(100) NOT NULL,
    CONSTRAINT FK_SUBTEMA_TEMA FOREIGN KEY (ID_TEMA) REFERENCES TEMA(ID_TEMA)
);

CREATE TABLE NOTICIA (
    ID_NOTICIA NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ID_TEMA NUMBER NOT NULL,
    ID_SUBTEMA NUMBER,
    TITULO VARCHAR2(200) NOT NULL,
    CONTENIDO CLOB NOT NULL,
    AUTOR VARCHAR2(100),
    FECHA_PUBLICACION DATE DEFAULT SYSDATE,
    VISITAS NUMBER DEFAULT 0,
    ENVIOS NUMBER DEFAULT 0,
    COMENTARIOS NUMBER DEFAULT 0,
    PROMEDIO_CALIFICACION NUMBER(3,2) DEFAULT 0,
    CONSTRAINT FK_NOTICIA_TEMA FOREIGN KEY (ID_TEMA) REFERENCES TEMA(ID_TEMA),
    CONSTRAINT FK_NOTICIA_SUBTEMA FOREIGN KEY (ID_SUBTEMA) REFERENCES SUBTEMA(ID_SUBTEMA)
);

CREATE TABLE CALIFICACION (
    ID_CALIFICACION NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ID_NOTICIA NUMBER NOT NULL,
    ID_USUARIO NUMBER NOT NULL,
    PUNTAJE NUMBER(1) CHECK (PUNTAJE BETWEEN 1 AND 5),
    FECHA_CALIFICACION DATE DEFAULT SYSDATE,
    CONSTRAINT FK_CALIFICACION_NOTICIA FOREIGN KEY (ID_NOTICIA) REFERENCES NOTICIA(ID_NOTICIA),
    CONSTRAINT FK_CALIFICACION_USUARIO FOREIGN KEY (ID_USUARIO) REFERENCES USUARIO(ID_USUARIO)
);

CREATE TABLE COMENTARIO (
    ID_COMENTARIO NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ID_NOTICIA NUMBER NOT NULL,
    ID_USUARIO NUMBER NOT NULL,
    TEXTO VARCHAR2(500) NOT NULL,
    FECHA_COMENTARIO DATE DEFAULT SYSDATE,
    CONSTRAINT FK_COMENTARIO_NOTICIA FOREIGN KEY (ID_NOTICIA) REFERENCES NOTICIA(ID_NOTICIA),
    CONSTRAINT FK_COMENTARIO_USUARIO FOREIGN KEY (ID_USUARIO) REFERENCES USUARIO(ID_USUARIO)
);

CREATE TABLE PREFERENCIA_ENVIO (
    ID_PREFERENCIA NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ID_USUARIO NUMBER NOT NULL,
    ID_TEMA NUMBER,
    ID_SUBTEMA NUMBER,
    AUTOR VARCHAR2(100),
    CONSTRAINT FK_PREF_USUARIO FOREIGN KEY (ID_USUARIO) REFERENCES USUARIO(ID_USUARIO)
);

CREATE TABLE ENVIO_AUTOMATICO (
    ID_ENVIO NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ID_USUARIO NUMBER NOT NULL,
    ID_NOTICIA NUMBER NOT NULL,
    FECHA_ENVIO DATE DEFAULT SYSDATE,
    CONSTRAINT FK_ENVIO_USUARIO FOREIGN KEY (ID_USUARIO) REFERENCES USUARIO(ID_USUARIO),
    CONSTRAINT FK_ENVIO_NOTICIA FOREIGN KEY (ID_NOTICIA) REFERENCES NOTICIA(ID_NOTICIA)
);

CREATE TABLE PARAMETRO_SISTEMA (
    CLAVE VARCHAR2(50) PRIMARY KEY,
    VALOR NUMBER
);

-- ----------------------------------------------------------
-- DATOS DE EJEMPLO
-- ----------------------------------------------------------

INSERT INTO TEMA (NOMBRE) VALUES ('Nacionales');
INSERT INTO TEMA (NOMBRE) VALUES ('Internacionales');
INSERT INTO TEMA (NOMBRE) VALUES ('Sucesos');

INSERT INTO SUBTEMA (ID_TEMA, NOMBRE) VALUES (2, 'América Latina');
INSERT INTO SUBTEMA (ID_TEMA, NOMBRE) VALUES (2, 'Europa');
INSERT INTO SUBTEMA (ID_TEMA, NOMBRE) VALUES (2, 'Asia');

INSERT INTO USUARIO (NOMBRE, EMAIL, PASSWORD) VALUES ('Juan Pérez', 'juan@mail.com', '1234');
INSERT INTO USUARIO (NOMBRE, EMAIL, PASSWORD) VALUES ('Ana López', 'ana@mail.com', 'abcd');
INSERT INTO USUARIO (NOMBRE, EMAIL, PASSWORD) VALUES ('Pedro Torres', 'pedro@mail.com', 'xyz');

INSERT INTO PARAMETRO_SISTEMA VALUES ('MAX_NOTICIAS', 10);

INSERT INTO NOTICIA (ID_TEMA, ID_SUBTEMA, TITULO, CONTENIDO, AUTOR) VALUES 
(2, 1, 'Cumbre Latinoamericana en marcha', 'Se reúnen los líderes de la región...', 'Carlos Méndez');
INSERT INTO NOTICIA (ID_TEMA, ID_SUBTEMA, TITULO, CONTENIDO, AUTOR) VALUES 
(2, 2, 'Elecciones en Europa', 'Los países europeos definen su futuro político...', 'Laura Ruiz');
INSERT INTO NOTICIA (ID_TEMA, TITULO, CONTENIDO, AUTOR) VALUES 
(1, 'Nuevo presupuesto nacional aprobado', 'El congreso aprobó el presupuesto...', 'Carlos Méndez');

COMMIT;

-- ==========================================================
-- PROCEDIMIENTOS Y FUNCIONES
-- ==========================================================

-- Aumentar visitas
CREATE OR REPLACE PROCEDURE AUMENTAR_VISITA (p_id_noticia IN NUMBER) AS
BEGIN
    UPDATE NOTICIA
    SET VISITAS = VISITAS + 1
    WHERE ID_NOTICIA = p_id_noticia;
    COMMIT;
END;
/
-- ----------------------------------------------------------

-- Registrar calificación y actualizar promedio
CREATE OR REPLACE PROCEDURE REGISTRAR_CALIFICACION (
    p_id_noticia IN NUMBER,
    p_id_usuario IN NUMBER,
    p_puntaje IN NUMBER
) AS
    v_promedio NUMBER(3,2);
BEGIN
    INSERT INTO CALIFICACION (ID_NOTICIA, ID_USUARIO, PUNTAJE)
    VALUES (p_id_noticia, p_id_usuario, p_puntaje);

    SELECT AVG(PUNTAJE)
    INTO v_promedio
    FROM CALIFICACION
    WHERE ID_NOTICIA = p_id_noticia;

    UPDATE NOTICIA
    SET PROMEDIO_CALIFICACION = v_promedio
    WHERE ID_NOTICIA = p_id_noticia;

    COMMIT;
END;
/
-- ----------------------------------------------------------

-- Listar últimas noticias
CREATE OR REPLACE FUNCTION LISTAR_ULTIMAS_NOTICIAS (
    p_id_tema IN NUMBER DEFAULT NULL
) RETURN SYS_REFCURSOR AS
    v_cursor SYS_REFCURSOR;
    v_max NUMBER;
BEGIN
    SELECT VALOR INTO v_max FROM PARAMETRO_SISTEMA WHERE CLAVE = 'MAX_NOTICIAS';

    OPEN v_cursor FOR
        SELECT *
        FROM NOTICIA
        WHERE (p_id_tema IS NULL OR ID_TEMA = p_id_tema)
        ORDER BY FECHA_PUBLICACION DESC
        FETCH FIRST v_max ROWS ONLY;

    RETURN v_cursor;
END;
/
-- ----------------------------------------------------------

-- Listar noticias más visitadas / enviadas / mejor calificadas
CREATE OR REPLACE FUNCTION LISTAR_TOP_NOTICIAS (
    p_tipo IN VARCHAR2,  
    p_id_tema IN NUMBER DEFAULT NULL
) RETURN SYS_REFCURSOR AS
    v_cursor SYS_REFCURSOR;
    v_max NUMBER;
BEGIN
    SELECT VALOR INTO v_max FROM PARAMETRO_SISTEMA WHERE CLAVE = 'MAX_NOTICIAS';

    IF p_tipo = 'VISITAS' THEN
        IF p_id_tema IS NULL THEN
            OPEN v_cursor FOR
                SELECT *
                FROM NOTICIA
                ORDER BY VISITAS DESC
                FETCH FIRST v_max ROWS ONLY;
        ELSE
            OPEN v_cursor FOR
                SELECT *
                FROM NOTICIA
                WHERE ID_TEMA = p_id_tema
                ORDER BY VISITAS DESC
                FETCH FIRST v_max ROWS ONLY;
        END IF;

    ELSIF p_tipo = 'ENVIOS' THEN
        IF p_id_tema IS NULL THEN
            OPEN v_cursor FOR
                SELECT *
                FROM NOTICIA
                ORDER BY ENVIOS DESC
                FETCH FIRST v_max ROWS ONLY;
        ELSE
            OPEN v_cursor FOR
                SELECT *
                FROM NOTICIA
                WHERE ID_TEMA = p_id_tema
                ORDER BY ENVIOS DESC
                FETCH FIRST v_max ROWS ONLY;
        END IF;

    ELSE  -- CALIFICACION
        IF p_id_tema IS NULL THEN
            OPEN v_cursor FOR
                SELECT *
                FROM NOTICIA
                ORDER BY PROMEDIO_CALIFICACION DESC
                FETCH FIRST v_max ROWS ONLY;
        ELSE
            OPEN v_cursor FOR
                SELECT *
                FROM NOTICIA
                WHERE ID_TEMA = p_id_tema
                ORDER BY PROMEDIO_CALIFICACION DESC
                FETCH FIRST v_max ROWS ONLY;
        END IF;
    END IF;

    RETURN v_cursor;
END;
/

-- ----------------------------------------------------------

-- Registrar envío automático (simulado)
CREATE OR REPLACE PROCEDURE REGISTRAR_ENVIO_AUTOMATICO (p_id_noticia IN NUMBER) AS
BEGIN
    INSERT INTO ENVIO_AUTOMATICO (ID_USUARIO, ID_NOTICIA)
    SELECT U.ID_USUARIO, p_id_noticia
    FROM USUARIO U
    JOIN PREFERENCIA_ENVIO P ON P.ID_USUARIO = U.ID_USUARIO
    JOIN NOTICIA N ON N.ID_NOTICIA = p_id_noticia
    WHERE (P.ID_TEMA = N.ID_TEMA OR P.ID_SUBTEMA = N.ID_SUBTEMA OR P.AUTOR = N.AUTOR);

    COMMIT;
END;
/
-- ==========================================================
-- PRUEBAS Y CONSULTAS DE EJEMPLO
-- ==========================================================

-- Aumentar visitas
EXEC AUMENTAR_VISITA(1);
EXEC AUMENTAR_VISITA(1);

-- Calificar noticias
EXEC REGISTRAR_CALIFICACION(1, 1, 5);
EXEC REGISTRAR_CALIFICACION(1, 2, 4);
EXEC REGISTRAR_CALIFICACION(2, 1, 3);

-- Verificar promedios
SELECT ID_NOTICIA, TITULO, PROMEDIO_CALIFICACION FROM NOTICIA;

-- Listar últimas noticias (todas)
VAR rc REFCURSOR;
EXEC :rc := LISTAR_ULTIMAS_NOTICIAS(NULL);
PRINT rc;

-- Listar más visitadas
VAR rc2 REFCURSOR;
EXEC :rc2 := LISTAR_TOP_NOTICIAS('VISITAS', NULL);
PRINT rc2;



-- Reporte: noticias por autor
SELECT AUTOR, COUNT(*) AS TOTAL FROM NOTICIA GROUP BY AUTOR;

-- Reporte: usuarios más activos
SELECT U.NOMBRE, COUNT(C.ID_CALIFICACION) AS TOTAL_CALIFICACIONES
FROM CALIFICACION C
JOIN USUARIO U ON C.ID_USUARIO = U.ID_USUARIO
GROUP BY U.NOMBRE
ORDER BY TOTAL_CALIFICACIONES DESC;

 */
package Base;


public interface base {
    
}
